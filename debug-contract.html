<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NFT ì»¨íŠ¸ë™íŠ¸ ë””ë²„ê¹… ë„êµ¬</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        max-width: 1200px;
        margin: 50px auto;
        padding: 20px;
        background: #1e1e1e;
        color: #d4d4d4;
      }
      h1 {
        color: #4ec9b0;
        border-bottom: 2px solid #4ec9b0;
        padding-bottom: 10px;
      }
      .section {
        background: #252526;
        border: 1px solid #3e3e42;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      .section h2 {
        color: #569cd6;
        margin-top: 0;
      }
      button {
        background: #0e639c;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }
      button:hover {
        background: #1177bb;
      }
      button:disabled {
        background: #555;
        cursor: not-allowed;
      }
      .result {
        background: #1e1e1e;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        color: #4ec9b0;
      }
      .error {
        color: #f48771;
      }
      .warning {
        color: #dcdcaa;
      }
      .info {
        color: #9cdcfe;
      }
      input {
        width: 100%;
        padding: 10px;
        background: #1e1e1e;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        color: #d4d4d4;
        font-size: 14px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” NFT ì»¨íŠ¸ë™íŠ¸ ë””ë²„ê¹… ë„êµ¬</h1>

    <div class="section">
      <h2>1. ì—°ê²° ì •ë³´</h2>
      <button onclick="connectWallet()">ì§€ê°‘ ì—°ê²°</button>
      <div id="walletInfo" class="result"></div>
    </div>

    <div class="section">
      <h2>2. ì»¨íŠ¸ë™íŠ¸ ì§„ë‹¨</h2>
      <label>ì»¨íŠ¸ë™íŠ¸ ì£¼ì†Œ:</label>
      <input
        type="text"
        id="contractAddress"
        value="0x8C9ecbA1e2540d4733c19b8e2F6d213a7248592a"
      />
      <button onclick="diagnoseContract()">ì»¨íŠ¸ë™íŠ¸ ì§„ë‹¨</button>
      <div id="diagnosisResult" class="result"></div>
    </div>

    <div class="section">
      <h2>3. ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ í™•ì¸</h2>
      <button onclick="checkFunctions()">í•¨ìˆ˜ ëª©ë¡ ì¡°íšŒ</button>
      <div id="functionsResult" class="result"></div>
    </div>

    <div class="section">
      <h2>4. ë¯¼íŒ… í…ŒìŠ¤íŠ¸ (ìˆ˜ë™)</h2>
      <label>ë©”íƒ€ë°ì´í„° URI:</label>
      <input type="text" id="tokenUri" placeholder="ipfs://..." />
      <button onclick="testMintTo()">mintTo í…ŒìŠ¤íŠ¸</button>
      <button onclick="testMint()">mint í…ŒìŠ¤íŠ¸</button>
      <button onclick="testSafeMint()">safeMint í…ŒìŠ¤íŠ¸</button>
      <div id="mintResult" class="result"></div>
    </div>

    <script>
      let provider;
      let signer;
      let address;
      let contract;

      async function connectWallet() {
        const result = document.getElementById("walletInfo");
        try {
          if (typeof window.ethereum === "undefined") {
            result.innerHTML =
              '<span class="error">âŒ MetaMaskê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span>';
            return;
          }

          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });
          address = accounts[0];

          const chainId = await window.ethereum.request({
            method: "eth_chainId",
          });
          const chainIdNum = parseInt(chainId, 16);

          result.innerHTML = `
<span class="success">âœ… ì§€ê°‘ ì—°ê²° ì„±ê³µ!</span>

<span class="info">ì§€ê°‘ ì£¼ì†Œ:</span> ${address}
<span class="info">ì²´ì¸ ID:</span> ${chainIdNum} ${
            chainIdNum === 84532
              ? "(Base Sepolia âœ“)"
              : "(âŒ Base Sepoliaê°€ ì•„ë‹™ë‹ˆë‹¤!)"
          }

${
  chainIdNum !== 84532
    ? '<span class="warning">âš ï¸ Base Sepoliaë¡œ ì „í™˜í•´ì£¼ì„¸ìš”!</span>'
    : ""
}
                `;

          if (chainIdNum !== 84532) {
            try {
              await window.ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: "0x14a34" }],
              });
              result.innerHTML +=
                '<span class="success">\\nâœ… Base Sepoliaë¡œ ì „í™˜ ì™„ë£Œ!</span>';
            } catch (error) {
              result.innerHTML += `<span class="error">\\nâŒ ë„¤íŠ¸ì›Œí¬ ì „í™˜ ì‹¤íŒ¨: ${error.message}</span>`;
            }
          }
        } catch (error) {
          result.innerHTML = `<span class="error">âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}</span>`;
        }
      }

      async function diagnoseContract() {
        const result = document.getElementById("diagnosisResult");
        const contractAddress =
          document.getElementById("contractAddress").value;

        if (!address) {
          result.innerHTML =
            '<span class="error">âŒ ë¨¼ì € ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”!</span>';
          return;
        }

        result.innerHTML = '<span class="info">ğŸ” ì§„ë‹¨ ì¤‘...</span>';

        try {
          const diagnostics = {
            paused: null,
            owner: null,
            isOwner: false,
            hasMinterRole: false,
            maxSupply: null,
            totalSupply: null,
          };

          // ABI ì •ì˜
          const erc721Abi = [
            "function paused() view returns (bool)",
            "function owner() view returns (address)",
            "function hasRole(bytes32 role, address account) view returns (bool)",
            "function maxSupply() view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function name() view returns (string)",
            "function symbol() view returns (string)",
          ];

          // ethers.js ì—†ì´ ì§ì ‘ í˜¸ì¶œ
          const calls = [];

          // 1. paused
          try {
            const data = await window.ethereum.request({
              method: "eth_call",
              params: [
                {
                  to: contractAddress,
                  data: "0x5c975abb", // paused()
                },
                "latest",
              ],
            });
            diagnostics.paused =
              data ===
              "0x0000000000000000000000000000000000000000000000000000000000000000"
                ? false
                : true;
          } catch (e) {
            diagnostics.paused = "N/A";
          }

          // 2. owner
          try {
            const data = await window.ethereum.request({
              method: "eth_call",
              params: [
                {
                  to: contractAddress,
                  data: "0x8da5cb5b", // owner()
                },
                "latest",
              ],
            });
            diagnostics.owner = "0x" + data.slice(-40);
            diagnostics.isOwner =
              diagnostics.owner.toLowerCase() === address.toLowerCase();
          } catch (e) {
            diagnostics.owner = "N/A";
          }

          // 3. totalSupply
          try {
            const data = await window.ethereum.request({
              method: "eth_call",
              params: [
                {
                  to: contractAddress,
                  data: "0x18160ddd", // totalSupply()
                },
                "latest",
              ],
            });
            diagnostics.totalSupply = parseInt(data, 16);
          } catch (e) {
            diagnostics.totalSupply = "N/A";
          }

          result.innerHTML = `
<span class="success">âœ… ì»¨íŠ¸ë™íŠ¸ ì§„ë‹¨ ì™„ë£Œ!</span>

<span class="info">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>
<span class="info">ğŸ“‹ ì»¨íŠ¸ë™íŠ¸ ì •ë³´</span>
<span class="info">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>

<span class="warning">ì£¼ì†Œ:</span> ${contractAddress}

<span class="warning">ì¼ì‹œì •ì§€ ìƒíƒœ:</span> ${
            diagnostics.paused === false
              ? '<span class="success">âœ“ í™œì„±í™”</span>'
              : diagnostics.paused === true
              ? '<span class="error">âœ— ì¼ì‹œì •ì§€ë¨</span>'
              : "N/A"
          }
<span class="warning">ì†Œìœ ì:</span> ${diagnostics.owner}
<span class="warning">í˜„ì¬ ê³„ì •ì´ ì†Œìœ ìì¸ê°€:</span> ${
            diagnostics.isOwner
              ? '<span class="success">âœ“ ì˜ˆ</span>'
              : '<span class="error">âœ— ì•„ë‹ˆì˜¤</span>'
          }
<span class="warning">ì´ ë°œí–‰ëŸ‰:</span> ${diagnostics.totalSupply}

<span class="info">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>
<span class="info">ğŸ’¡ ë¶„ì„ ê²°ê³¼</span>
<span class="info">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>

${
  diagnostics.paused === true
    ? '<span class="error">âŒ ì»¨íŠ¸ë™íŠ¸ê°€ ì¼ì‹œì •ì§€ ìƒíƒœì…ë‹ˆë‹¤!</span>\\n'
    : ""
}
${
  !diagnostics.isOwner
    ? '<span class="warning">âš ï¸ í˜„ì¬ ê³„ì •ì´ ì»¨íŠ¸ë™íŠ¸ ì†Œìœ ìê°€ ì•„ë‹™ë‹ˆë‹¤.</span>\\n'
    : ""
}
${
  diagnostics.isOwner
    ? '<span class="success">âœ… ì†Œìœ ì ê³„ì •ìœ¼ë¡œ ì—°ê²°ë¨ - ë¯¼íŒ… ê¶Œí•œ ìˆìŒ!</span>\\n'
    : ""
}

<span class="info">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>

<span class="warning">ë‹¤ìŒ ë‹¨ê³„:</span>
1. "ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ í™•ì¸" ë²„íŠ¼ í´ë¦­
2. mintTo, mint, safeMint í•¨ìˆ˜ ì¡´ì¬ í™•ì¸
3. ë¯¼íŒ… í…ŒìŠ¤íŠ¸ ì§„í–‰
                `;
        } catch (error) {
          result.innerHTML = `<span class="error">âŒ ì§„ë‹¨ ì‹¤íŒ¨: ${error.message}</span>`;
        }
      }

      async function checkFunctions() {
        const result = document.getElementById("functionsResult");
        result.innerHTML = `
<span class="info">ğŸ” ì»¨íŠ¸ë™íŠ¸ í•¨ìˆ˜ í™•ì¸ ì¤‘...</span>

<span class="warning">ì¶”ì²œ: thirdweb ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”!</span>
ğŸ‘‰ https://thirdweb.com/base-sepolia-testnet/${
          document.getElementById("contractAddress").value
        }

<span class="info">ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•  í•­ëª©:</span>
1. "Explorer" íƒ­ â†’ "Functions" í™•ì¸
2. mintTo, mint, safeMint í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€
3. ê° í•¨ìˆ˜ì˜ íŒŒë¼ë¯¸í„° íƒ€ì… í™•ì¸

<span class="success">ë˜ëŠ” Base Sepolia Etherscanì—ì„œ í™•ì¸:</span>
ğŸ‘‰ https://sepolia.basescan.org/address/${
          document.getElementById("contractAddress").value
        }#code
            `;
      }

      async function testMintTo() {
        const result = document.getElementById("mintResult");
        const contractAddress =
          document.getElementById("contractAddress").value;
        const tokenUri = document.getElementById("tokenUri").value;

        if (!address) {
          result.innerHTML =
            '<span class="error">âŒ ë¨¼ì € ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”!</span>';
          return;
        }

        if (!tokenUri) {
          result.innerHTML =
            '<span class="error">âŒ ë©”íƒ€ë°ì´í„° URIë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!</span>';
          return;
        }

        result.innerHTML =
          '<span class="info">ğŸ”„ mintTo í•¨ìˆ˜ í˜¸ì¶œ ì¤‘...</span>';

        try {
          // mintTo(address to, string uri) í•¨ìˆ˜ í˜¸ì¶œ
          const params = [
            {
              from: address,
              to: contractAddress,
              data:
                "0x" +
                "755edd17" + // mintTo(address,string) function selector
                address.slice(2).padStart(64, "0") + // to address
                "0000000000000000000000000000000000000000000000000000000000000040" + // string offset
                tokenUri.length.toString(16).padStart(64, "0") + // string length
                Buffer.from(tokenUri)
                  .toString("hex")
                  .padEnd(Math.ceil(tokenUri.length / 32) * 64, "0"), // string data
            },
          ];

          const txHash = await window.ethereum.request({
            method: "eth_sendTransaction",
            params,
          });

          result.innerHTML = `
<span class="success">âœ… íŠ¸ëœì­ì…˜ ì „ì†¡ ì„±ê³µ!</span>

<span class="warning">TX Hash:</span> ${txHash}

<span class="info">Etherscanì—ì„œ í™•ì¸:</span>
ğŸ‘‰ https://sepolia.basescan.org/tx/${txHash}
                `;
        } catch (error) {
          result.innerHTML = `
<span class="error">âŒ mintTo ì‹¤íŒ¨!</span>

<span class="warning">ì—ëŸ¬:</span> ${error.message}

<span class="info">ê°€ëŠ¥í•œ ì›ì¸:</span>
â€¢ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ê°€ ë‹¤ë¦„
â€¢ ê¶Œí•œ ë¶€ì¡±
â€¢ ê°€ìŠ¤ ë¶€ì¡±
                `;
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²° ì‹œë„
      window.addEventListener("load", () => {
        if (typeof window.ethereum !== "undefined") {
          window.ethereum
            .request({ method: "eth_accounts" })
            .then((accounts) => {
              if (accounts.length > 0) {
                connectWallet();
              }
            });
        }
      });
    </script>
  </body>
</html>
